import{q as V,y as H,r as d,j as e,B as S,S as E}from"./index-D0zBGyDj.js";import{a as u,I as c,P as K}from"./IconifyIcon-DxrtKAFV.js";import{f as y}from"./csrf-DhkfgJmo.js";import{T as A}from"./Typography-BMrFWdWq.js";import{A as W}from"./Alert-D0WIFuVH.js";import{G as h}from"./Grid-BRaV7QJi.js";import{T as I}from"./TextField-Cg6oPGF_.js";import{F as Q,S as X}from"./Switch-D46eJ3ud.js";import{A as Y,a as Z,b as ee}from"./AccordionSummary-BG1DXLd2.js";import{B as w}from"./Button-Ch97SugN.js";import"./useSlot-BKua55if.js";import"./Menu-B5xWsZiJ.js";const he=()=>{const p=V(),{id:m}=H(),f=!!m,[a,g]=d.useState({name:"",subtitle:"",icon:"",backgroundColor:"#000000",url:"",order:0,isActive:!0}),[l,j]=d.useState([]),[$,L]=d.useState([]),[z,C]=d.useState(""),[T,U]=d.useState(!1),[v,F]=d.useState(!1),[D,n]=d.useState(""),[P,x]=d.useState("");d.useEffect(()=>{O(),f&&B()},[m]);const O=async()=>{try{const r=await(await fetch("/api/categories?all=1",{credentials:"include"})).json();Array.isArray(r)&&L(r.filter(t=>!t.parentId).map(t=>({id:t.id,name:t.name,order:t.order})))}catch(o){console.error("Error fetching categories:",o)}},B=async()=>{if(m)try{const r=await(await fetch(`/api/categories/${m}`,{credentials:"include"})).json();r&&(g({name:r.name||"",subtitle:r.subtitle||"",icon:r.icon||"",backgroundColor:r.backgroundColor||"#000000",url:r.url||"",order:r.order??0,isActive:r.isActive??!0}),C(r.icon||""),j((r.subcategories||[]).map(t=>({id:t.id,name:t.name}))))}catch(o){console.error("Error fetching category:",o),n("Erreur lors du chargement")}},R=()=>{j([...l,{name:""}])},M=(o,r)=>{const t=[...l];t[o]={...t[o],name:r},j(t)},N=o=>{j(l.filter((r,t)=>t!==o))},G=o=>{const r=l[o];if(!m||!r?.name?.trim())return;const t=new URLSearchParams({parentId:m,name:r.name.trim()});p(`/categories/subcategory/new?${t.toString()}`)},J=async o=>{const r=l[o];if(!r?.id){N(o);return}if(confirm("Supprimer cette sous-catÃ©gorie ?"))try{const t=await y(`/api/categories/${r.id}`,{method:"DELETE"});if(t.ok)x("Sous-catÃ©gorie supprimÃ©e"),j(l.filter((i,s)=>s!==o));else{const i=await t.json();n(i.error||"Erreur lors de la suppression")}}catch(t){console.error("Delete error:",t),n("Erreur lors de la suppression")}},_=async o=>{const r=o.target.files?.[0];if(!r)return;const t=URL.createObjectURL(r);C(t),F(!0);try{const i=r.type.startsWith("image/")&&r.size<1048576;let s;if(i){const b=new FormData;b.append("file",r),s=await y("/api/upload",{method:"POST",body:b})}else{const b=`/api/upload?filename=${encodeURIComponent(r.name)}`;s=await y(b,{method:"POST",headers:{"Content-Type":"application/octet-stream","x-file-name":encodeURIComponent(r.name)},body:r})}const k=await s.json();k.success?(g(b=>({...b,icon:k.url})),x("Image uploadÃ©e avec succÃ¨s")):n(k.message||"Erreur lors de l'upload")}catch(i){console.error("Upload error:",i),n("Erreur lors de l'upload du fichier")}finally{F(!1)}},q=async()=>{if(n(""),x(""),!a.name?.trim()||!a.subtitle?.trim()){n("Veuillez remplir tous les champs obligatoires");return}let o=a.url?.trim();o||(o="/"+a.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""));const r={...a,url:o};U(!0);try{if(f){const t={...r,subcategories:l.filter(s=>s.name.trim())},i=await y(`/api/categories/${m}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(i.ok)x("CatÃ©gorie modifiÃ©e avec succÃ¨s"),setTimeout(()=>p("/categories"),1500);else{const s=await i.json();n(s.error||"Erreur lors de la modification")}}else{const t={...r,order:$.length,subcategories:l.filter(s=>s.name.trim())},i=await y("/api/categories",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(i.ok)x("CatÃ©gorie ajoutÃ©e avec succÃ¨s"),setTimeout(()=>p("/categories"),1500);else{const s=await i.json();n(s.error||"Erreur lors de l'ajout")}}}catch(t){console.error("Submit error:",t),n("Erreur lors de l'opÃ©ration")}finally{U(!1)}};return e.jsxs(S,{children:[e.jsxs(E,{direction:"row",alignItems:"center",justifyContent:"space-between",mb:3,children:[e.jsx(u,{onClick:()=>p("/categories"),sx:{color:"text.primary",bgcolor:"background.paper",boxShadow:1,"&:hover":{bgcolor:"action.hover"}},children:e.jsx(c,{icon:"mdi:arrow-left",width:24,height:24})}),e.jsx(A,{variant:"h4",children:f?"Modifier la catÃ©gorie":"Nouvelle catÃ©gorie"}),e.jsx(S,{sx:{width:40}})]}),D&&e.jsx(W,{severity:"error",sx:{mb:2},onClose:()=>n(""),children:D}),P&&e.jsx(W,{severity:"success",sx:{mb:2},onClose:()=>x(""),children:P}),e.jsx(K,{component:"form",sx:{p:{xs:3,sm:4}},onSubmit:o=>{o.preventDefault(),q()},children:e.jsxs(h,{container:!0,spacing:3,children:[e.jsx(h,{item:!0,xs:12,sm:6,children:e.jsx(I,{label:"Nom *",fullWidth:!0,size:"small",value:a.name,onChange:o=>g(r=>({...r,name:o.target.value})),placeholder:"Site Web"})}),e.jsx(h,{item:!0,xs:12,sm:6,children:e.jsx(I,{label:"Sous-titre *",fullWidth:!0,size:"small",value:a.subtitle,onChange:o=>g(r=>({...r,subtitle:o.target.value})),placeholder:"FRONTEND"})}),e.jsx(h,{item:!0,xs:12,sm:6,children:e.jsx(Q,{control:e.jsx(X,{checked:a.isActive,onChange:o=>g(r=>({...r,isActive:o.target.checked}))}),label:"Actif"})}),e.jsx(h,{item:!0,xs:12,children:e.jsxs(Y,{defaultExpanded:!0,sx:{border:"1px solid",borderColor:"divider",boxShadow:"none"},children:[e.jsx(Z,{expandIcon:e.jsx(c,{icon:"material-symbols:expand-more"}),children:e.jsxs(A,{variant:"subtitle1",sx:{fontWeight:600},children:["Sous-catÃ©gories (",l.length,")"]})}),e.jsxs(ee,{children:[e.jsx(w,{variant:"contained",size:"small",onClick:R,startIcon:e.jsx(c,{icon:"material-symbols:add"}),sx:{mb:2},children:"Ajouter une sous-catÃ©gorie"}),l.map((o,r)=>e.jsxs(S,{sx:{p:1.5,mb:1.5,border:"1px solid",borderColor:"divider",borderRadius:1,bgcolor:"background.paper",display:"flex",alignItems:"center",gap:2},children:[e.jsx(I,{label:"Nom",size:"small",fullWidth:!0,value:o.name,onChange:t=>M(r,t.target.value),placeholder:"ex: Espagnol ou ðŸŒ¿ Fleurs"}),o.id?e.jsxs(e.Fragment,{children:[e.jsx(u,{onClick:()=>p(`/categories/subcategory/edit/${o.id}`),size:"small",sx:{bgcolor:"action.hover",width:36,height:36,"&:hover":{bgcolor:"primary.lighter",color:"primary.main"}},title:"Modifier (icÃ´ne, sous-titre...)",children:e.jsx(c,{icon:"material-symbols:edit-outline",fontSize:"small"})}),e.jsx(u,{onClick:()=>J(r),size:"small",sx:{bgcolor:"error.main",color:"white",width:36,height:36,"&:hover":{bgcolor:"error.dark"}},title:"Supprimer la sous-catÃ©gorie",children:e.jsx(c,{icon:"material-symbols:delete",fontSize:"small"})})]}):e.jsxs(E,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(u,{onClick:R,size:"small",sx:{bgcolor:"success.main",color:"white",width:36,height:36,"&:hover":{bgcolor:"success.dark"}},title:"Ajouter une sous-catÃ©gorie",children:e.jsx(c,{icon:"material-symbols:add",width:22,height:22})}),f&&e.jsx(u,{onClick:()=>G(r),disabled:!o.name?.trim(),size:"small",sx:{bgcolor:"primary.main",color:"white",width:36,height:36,"&:hover":{bgcolor:"primary.dark"}},title:"CrÃ©er cette sous-catÃ©gorie",children:e.jsx(c,{icon:"mdi:check",width:22,height:22})}),e.jsx(u,{onClick:()=>N(r),size:"small",sx:{color:"text.secondary",width:36,height:36,"&:hover":{bgcolor:"action.hover",color:"error.main"}},title:"Retirer de la liste",children:e.jsx(c,{icon:"material-symbols:close",fontSize:"small"})})]})]},o.id||`new-${r}`))]})]})}),e.jsxs(h,{item:!0,xs:12,children:[e.jsx(A,{variant:"subtitle2",color:"text.disabled",mb:1,children:"Photo"}),(z||a.icon)&&e.jsxs(S,{sx:{mb:2},children:[e.jsx("img",{src:z||a.icon,alt:"Preview",style:{width:60,height:60,objectFit:"cover",borderRadius:8,border:"1px solid #444"}}),e.jsx(u,{size:"small",onClick:()=>{g(o=>({...o,icon:""})),C("")},sx:{ml:1,color:"error.main"},children:e.jsx(c,{icon:"material-symbols:delete",width:20})})]}),e.jsxs(w,{component:"label",variant:"outlined",disabled:v,startIcon:v?e.jsx(c,{icon:"eos-icons:loading"}):e.jsx(c,{icon:"material-symbols:upload"}),children:[v?"Upload en cours...":a.icon?"Changer la photo":"Choisir une photo",e.jsx("input",{type:"file",hidden:!0,accept:"image/*",onChange:_})]})]}),e.jsx(h,{item:!0,xs:12,children:e.jsxs(E,{direction:"row",spacing:2,justifyContent:"flex-end",children:[e.jsx(w,{type:"button",variant:"outlined",onClick:()=>p("/categories"),sx:{minWidth:120},children:"Annuler"}),e.jsx(w,{type:"submit",variant:"contained",disabled:T||v,sx:{bgcolor:"primary.main",color:"common.black",minWidth:120,"&:hover":{bgcolor:"primary.dark"}},children:T?"Sauvegarde...":f?"Modifier":"Ajouter"})]})})]})})]})};export{he as default};
