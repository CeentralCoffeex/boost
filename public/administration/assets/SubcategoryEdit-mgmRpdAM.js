import{q,J as M,y as H,r as i,j as t,B as C,S as $}from"./index-D0zBGyDj.js";import{a as O,I as j,P as K}from"./IconifyIcon-DxrtKAFV.js";import{f as S}from"./csrf-DhkfgJmo.js";import{T as W}from"./Typography-BMrFWdWq.js";import{A as w}from"./Alert-D0WIFuVH.js";import{G as p}from"./Grid-BRaV7QJi.js";import{T as z}from"./TextField-Cg6oPGF_.js";import{F as Q,S as V}from"./Switch-D46eJ3ud.js";import{B as k}from"./Button-Ch97SugN.js";import"./useSlot-BKua55if.js";import"./Menu-B5xWsZiJ.js";const ne=()=>{const y=q(),[E]=M(),{id:h}=H(),n=E.get("parentId")||"",d=E.get("name")||"",u=!!h,[o,c]=i.useState({name:d,subtitle:d,icon:"",backgroundColor:"#000000",url:"",order:0,isActive:!0}),[I,P]=i.useState(null),[U,v]=i.useState(""),[T,A]=i.useState(!1),[f,F]=i.useState(!1),[L,l]=i.useState(""),[N,x]=i.useState("");i.useEffect(()=>{d&&c(r=>({...r,name:d,subtitle:d}))},[d]),i.useEffect(()=>{n&&B(),u&&D()},[n,h]);const B=async()=>{try{const e=await(await fetch(`/api/categories/${n}`,{credentials:"include"})).json();e?.id&&(P({id:e.id,name:e.name}),c(g=>({...g,backgroundColor:e.backgroundColor||"#000000"})))}catch(r){console.error("Error fetching parent:",r)}},D=async()=>{if(h)try{const e=await(await fetch(`/api/categories/${h}`,{credentials:"include"})).json();e&&(c({name:e.name||"",subtitle:e.subtitle||e.name||"",icon:e.icon||"",backgroundColor:e.backgroundColor||"#000000",url:e.url||"",order:e.order??0,isActive:e.isActive??!0}),v(e.icon||""),e.parentId&&P({id:e.parentId,name:e.parent?.name||""}))}catch(r){console.error("Error fetching subcategory:",r),l("Erreur lors du chargement")}},G=async r=>{const e=r.target.files?.[0];if(!e)return;const g=URL.createObjectURL(e);v(g),F(!0);try{const s=e.type.startsWith("image/")&&e.size<1048576;let b;if(s){const a=new FormData;a.append("file",e),b=await S("/api/upload",{method:"POST",body:a})}else{const a=`/api/upload?filename=${encodeURIComponent(e.name)}`;b=await S(a,{method:"POST",headers:{"Content-Type":"application/octet-stream","x-file-name":encodeURIComponent(e.name)},body:e})}const m=await b.json();m.success?(c(a=>({...a,icon:m.url})),x("Image uploadée avec succès")):l(m.message||"Erreur lors de l'upload")}catch(s){console.error("Upload error:",s),l("Erreur lors de l'upload du fichier")}finally{F(!1)}},J=async()=>{if(l(""),x(""),!o.name?.trim()){l("Le nom est obligatoire");return}const r=s=>s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");let e=o.url?.trim();e?e="/"+r(e.replace(/^\//,"")):e="/"+r(o.name);const g={...o,url:e,subtitle:o.subtitle?.trim()||o.name,parentId:u?void 0:n};A(!0);try{const s=u?`/api/categories/${h}`:"/api/categories",m=await S(s,{method:u?"PUT":"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)});if(m.ok){x(u?"Sous-catégorie modifiée":"Sous-catégorie créée");const a=n?`/categories?edit=${n}`:"/categories";setTimeout(()=>y(a),1500)}else{const a=await m.json();l(a.error||"Erreur lors de la sauvegarde")}}catch(s){console.error("Submit error:",s),l("Erreur lors de la sauvegarde")}finally{A(!1)}},R=n?`/categories/edit/${n}`:"/categories";return t.jsxs(C,{children:[t.jsxs($,{direction:"row",alignItems:"center",justifyContent:"space-between",mb:3,children:[t.jsx(O,{onClick:()=>y(R),sx:{color:"text.primary",bgcolor:"background.paper",boxShadow:1,"&:hover":{bgcolor:"action.hover"}},children:t.jsx(j,{icon:"mdi:arrow-left",width:24,height:24})}),t.jsx(W,{variant:"h4",children:u?"Modifier la sous-catégorie":"Nouvelle sous-catégorie"}),t.jsx(C,{sx:{width:40}})]}),I&&t.jsxs(w,{severity:"info",sx:{mb:2},children:["Catégorie parente : ",t.jsx("strong",{children:I.name})]}),L&&t.jsx(w,{severity:"error",sx:{mb:2},onClose:()=>l(""),children:L}),N&&t.jsx(w,{severity:"success",sx:{mb:2},onClose:()=>x(""),children:N}),t.jsx(K,{sx:{p:{xs:3,sm:4}},children:t.jsxs(p,{container:!0,spacing:3,children:[t.jsx(p,{item:!0,xs:12,sm:6,children:t.jsx(z,{label:"Nom *",fullWidth:!0,value:o.name,onChange:r=>c(e=>({...e,name:r.target.value,subtitle:e.subtitle===e.name?r.target.value:e.subtitle})),placeholder:"ex: Espagnol"})}),t.jsx(p,{item:!0,xs:12,sm:6,children:t.jsx(z,{label:"Sous-titre",fullWidth:!0,value:o.subtitle,onChange:r=>c(e=>({...e,subtitle:r.target.value})),placeholder:"ex: ESPAGNOL"})}),t.jsx(p,{item:!0,xs:12,sm:6,children:t.jsx(Q,{control:t.jsx(V,{checked:o.isActive,onChange:r=>c(e=>({...e,isActive:r.target.checked}))}),label:"Actif"})}),t.jsxs(p,{item:!0,xs:12,children:[t.jsx(W,{variant:"subtitle2",color:"text.disabled",mb:1,children:"Photo"}),(U||o.icon)&&t.jsxs(C,{sx:{mb:2},children:[t.jsx("img",{src:U||o.icon,alt:"Preview",style:{width:60,height:60,objectFit:"cover",borderRadius:8,border:"1px solid #444"}}),t.jsx(O,{size:"small",onClick:()=>{c(r=>({...r,icon:""})),v("")},sx:{ml:1,color:"error.main"},children:t.jsx(j,{icon:"material-symbols:delete",width:20})})]}),t.jsxs(k,{component:"label",variant:"outlined",disabled:f,startIcon:f?t.jsx(j,{icon:"eos-icons:loading"}):t.jsx(j,{icon:"material-symbols:upload"}),children:[f?"Upload...":o.icon?"Changer":"Choisir une photo",t.jsx("input",{type:"file",hidden:!0,accept:"image/*",onChange:G})]})]}),t.jsx(p,{item:!0,xs:12,children:t.jsxs($,{direction:"row",spacing:2,justifyContent:"flex-end",children:[t.jsx(k,{variant:"outlined",onClick:()=>y(R),sx:{minWidth:120},children:"Annuler"}),t.jsx(k,{variant:"contained",onClick:J,disabled:T||f,sx:{bgcolor:"primary.main",color:"common.black",minWidth:120,"&:hover":{bgcolor:"primary.dark"}},children:T?"Sauvegarde...":"Enregistrer"})]})})]})})]})};export{ne as default};
