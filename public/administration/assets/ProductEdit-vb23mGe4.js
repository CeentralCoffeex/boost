import{q as te,y as se,r as c,j as e,B as f,S as j,z as ie}from"./index-D0zBGyDj.js";import{a as z,I as x,P as ae}from"./IconifyIcon-DxrtKAFV.js";import{R as ne}from"./RichTextBlock-BBn9cSDk.js";import{f as A,u as le}from"./csrf-DhkfgJmo.js";import{T as b}from"./Typography-BMrFWdWq.js";import{A as G}from"./Alert-D0WIFuVH.js";import{G as d}from"./Grid-BRaV7QJi.js";import{T as y}from"./TextField-Cg6oPGF_.js";import{M as T}from"./MenuItem-B2F399_H.js";import{A as ce,a as de,b as ue}from"./AccordionSummary-BG1DXLd2.js";import{B as M}from"./Button-Ch97SugN.js";import"./Menu-B5xWsZiJ.js";import"./useSlot-BKua55if.js";function pe(w){const m=w.split("?")[0].toLowerCase();return m.endsWith(".mov")||m.endsWith(".qt")?"video/quicktime":m.endsWith(".webm")?"video/webm":m.endsWith(".ogg")?"video/ogg":"video/mp4"}const Re=()=>{const w=te(),{id:m}=se(),C=!!m,[s,u]=c.useState({title:"",description:"",basePrice:"",tag:"",image:"",videoUrl:"",categoryId:""}),[W,D]=c.useState(""),[I,S]=c.useState(""),[h,E]=c.useState([]),[q,J]=c.useState([]),[O,_]=c.useState(!1),[U,P]=c.useState(!1),[L,V]=c.useState(0),[B,n]=c.useState(""),[N,R]=c.useState("");c.useEffect(()=>{K(),C&&Q()},[m]),c.useEffect(()=>{!W&&s.image&&D(s.image),!I&&s.videoUrl&&S(s.videoUrl)},[s.image,s.videoUrl]);const K=async()=>{try{const o=await(await fetch("/api/categories?all=1",{credentials:"include"})).json();Array.isArray(o)&&J(o)}catch(r){console.error("Error fetching categories:",r)}},F=q.filter(r=>!r.parentId),v=F.find(r=>r.id===s.categoryId)??F.find(r=>r.subcategories?.some(o=>o.id===s.categoryId)),k=v?.subcategories??[],H=v&&k.length>0&&s.categoryId&&k.some(r=>r.id===s.categoryId)?s.categoryId:"",Q=async()=>{try{const o=await(await fetch(`/api/products/${m}`,{credentials:"include"})).json();o&&(u({title:o.title||"",description:o.description||"",basePrice:o.basePrice||"",tag:o.tag||"",image:o.image||"",videoUrl:o.videoUrl||"",categoryId:o.categoryId||""}),E(o.variants||[]))}catch(r){console.error("Error fetching product:",r),n("Erreur lors du chargement du produit")}},X=async r=>{const o=r.target.files?.[0];if(!o)return;const i=URL.createObjectURL(o);D(i),P(!0);try{let t;if(!(o.type.startsWith("image/")&&o.size<1048576)){const p=`/api/upload?filename=${encodeURIComponent(o.name)}`;t=await A(p,{method:"POST",headers:{"Content-Type":"application/octet-stream","x-file-name":encodeURIComponent(o.name)},body:o})}else{const p=new FormData;p.append("file",o),t=await A("/api/upload",{method:"POST",body:p})}const l=await t.json();l.success&&l.url?(u(p=>({...p,image:l.url})),R("Fichier uploadé avec succès")):(console.warn("Upload success but no URL or failed",l),l.success||n(l.message||"Erreur lors de l'upload"))}catch(t){console.error("Upload error:",t),n("Erreur lors de l'upload du fichier")}finally{P(!1)}},Y=async r=>{const o=r.target.files?.[0];if(!o)return;const i=URL.createObjectURL(o);S(i),P(!0),V(0);try{let t;if(o.size>1048576||o.type.startsWith("video/")){const p=`${typeof window<"u"?window.location.origin:""}/api/upload?filename=${encodeURIComponent(o.name)}`;t=await le(p,o,{onProgress:oe=>V(oe)})}else{const l=new FormData;l.append("file",o),t=await A("/api/upload",{method:"POST",body:l})}const a=await t.json();if(console.log("Upload response:",{success:a.success,url:a.url,type:a.type,fileName:a.fileName,size:a.size}),a.success&&a.url){try{URL.revokeObjectURL(i)}catch{}const l=a.url.startsWith("http")?a.url:(typeof window<"u"?window.location.origin:"")+a.url;u(p=>({...p,videoUrl:a.url})),S(l),R("Vidéo uploadée avec succès")}else console.warn("Video upload success but no URL or failed",a),a.success||n(a.message||"Erreur lors de l'upload")}catch(t){console.error("Upload error:",t);try{URL.revokeObjectURL(i)}catch{}n("Erreur lors de l'upload de la vidéo")}finally{P(!1),V(0)}},Z=async()=>{if(!s.title||!s.description){n("Veuillez remplir tous les champs obligatoires (Titre, Description)");return}if(I&&!s.videoUrl){n("La vidéo n’a pas été enregistrée. Attendez la fin de l’upload ou réessayez.");return}if(h.length===0){n("Veuillez ajouter au moins un tarif (Grammage + Prix)");return}_(!0),n(""),R("");try{const r=C?`/api/products/${m}`:"/api/products",o=C?"PUT":"POST",i={...s,basePrice:h[0]?.price||"0",variants:h},t=await A(r,{method:o,headers:{"Content-Type":"application/json"},body:JSON.stringify(i),credentials:"include"});if(t.ok)R(C?"Produit modifié avec succès":"Produit créé avec succès"),setTimeout(()=>w("/product"),1500);else{const g=await t.json();n(g.error||"Erreur lors de la sauvegarde")}}catch(r){console.error("Submit error:",r),n("Erreur lors de la sauvegarde du produit")}finally{_(!1)}},ee=()=>{E([...h,{name:"",type:"weight",price:""}])},$=(r,o,i)=>{const t=[...h];t[r]={...t[r],[o]:i},E(t)},re=r=>{E(h.filter((o,i)=>i!==r))};return e.jsxs(f,{children:[e.jsxs(j,{direction:"row",alignItems:"center",justifyContent:"space-between",mb:3,children:[e.jsx(z,{onClick:()=>w("/product"),sx:{color:"text.primary",bgcolor:"background.paper",boxShadow:1,"&:hover":{bgcolor:"action.hover"}},children:e.jsx(x,{icon:"mdi:arrow-left",width:24,height:24})}),e.jsx(b,{variant:"h4",children:C?"Modifier le produit":"Nouveau produit"}),e.jsx(f,{sx:{width:40}})," "]}),B&&e.jsx(G,{severity:"error",sx:{mb:2},onClose:()=>n(""),children:B}),N&&e.jsx(G,{severity:"success",sx:{mb:2},onClose:()=>R(""),children:N}),e.jsx(ae,{sx:{p:{xs:3,sm:4}},children:e.jsxs(d,{container:!0,spacing:3,children:[e.jsxs(d,{item:!0,xs:12,children:[e.jsx(b,{variant:"subtitle2",color:"text.secondary",mb:1,children:"Médias (Image & Vidéo)"}),e.jsxs(j,{direction:"row",spacing:2,children:[e.jsxs(f,{sx:{width:150,height:150,border:"1px dashed",borderColor:"divider",borderRadius:1,overflow:"hidden",position:"relative",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",bgcolor:"background.default","&:hover":{borderColor:"primary.main",bgcolor:"action.hover"}},onClick:()=>document.getElementById("image-upload")?.click(),children:[e.jsx("input",{id:"image-upload",type:"file",hidden:!0,accept:"image/*",onChange:X}),W?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:W,alt:"Preview",style:{width:"100%",height:"100%",objectFit:"cover"}}),e.jsx(z,{size:"small",onClick:r=>{r.stopPropagation(),u({...s,image:""}),D("")},sx:{position:"absolute",top:4,right:4,bgcolor:"rgba(255,255,255,0.8)","&:hover":{bgcolor:"error.main",color:"white"},zIndex:2},children:e.jsx(x,{icon:"material-symbols:close",width:16})})]}):e.jsxs(j,{alignItems:"center",spacing:1,sx:{color:"text.secondary"},children:[e.jsx(x,{icon:U?"eos-icons:loading":"material-symbols:add-photo-alternate",width:32}),e.jsx(b,{variant:"caption",children:"Image"})]})]}),e.jsxs(f,{sx:{width:150,height:150,border:"1px dashed",borderColor:"divider",borderRadius:1,overflow:"hidden",position:"relative",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",bgcolor:"background.default","&:hover":{borderColor:"primary.main",bgcolor:"action.hover"}},onClick:()=>document.getElementById("video-upload")?.click(),children:[e.jsx("input",{id:"video-upload",type:"file",hidden:!0,accept:"video/*",onChange:Y}),I?e.jsxs(e.Fragment,{children:[e.jsxs("video",{style:{width:"100%",height:"100%",objectFit:"cover"},muted:!0,playsInline:!0,controls:!0,preload:"auto",onError:r=>{const o=r.target,i=o.error;let t="Erreur inconnue",g="N/A";i&&(g=i.code.toString(),i.code===1?t="Lecture annulée (MEDIA_ERR_ABORTED)":i.code===2?t="Problème réseau (MEDIA_ERR_NETWORK)":i.code===3?t="Erreur décodage (MEDIA_ERR_DECODE)":i.code===4&&(t="Format non supporté (MEDIA_ERR_SRC_NOT_SUPPORTED)"),console.error("Video playback error:",{code:i.code,message:i.message,src:o.src,currentSrc:o.currentSrc,networkState:o.networkState,readyState:o.readyState})),alert(`Impossible de lire la vidéo : ${t} (Code: ${g})

URL: ${o.src}

Essayez de l'ouvrir dans un nouvel onglet pour tester.`)},children:[e.jsx("source",{src:I,type:pe(I)}),"Votre navigateur ne supporte pas la lecture de vidéos."]}),e.jsx(z,{size:"small",onClick:r=>{r.stopPropagation(),u({...s,videoUrl:""}),S("")},sx:{position:"absolute",top:4,right:4,bgcolor:"rgba(255,255,255,0.8)","&:hover":{bgcolor:"error.main",color:"white"},zIndex:2},children:e.jsx(x,{icon:"material-symbols:close",width:16})})]}):e.jsxs(j,{alignItems:"center",spacing:1,sx:{color:"text.secondary"},children:[e.jsx(x,{icon:U?"eos-icons:loading":"material-symbols:video-library",width:32}),e.jsx(b,{variant:"caption",children:"Vidéo"})]})]}),U&&L>0&&e.jsxs(f,{sx:{mt:.5},children:[e.jsx(ie,{variant:"determinate",value:L,color:"primary",sx:{height:6,borderRadius:1}}),e.jsxs(b,{variant:"caption",color:"text.secondary",sx:{mt:.5,display:"block"},children:[L,"%"]})]})]})]}),e.jsx(d,{item:!0,xs:12,children:e.jsx(y,{label:"Titre",fullWidth:!0,value:s.title,onChange:r=>u({...s,title:r.target.value})})}),e.jsx(d,{item:!0,xs:12,children:e.jsx(ne,{label:"Description",value:s.description,onChange:r=>u({...s,description:r}),minRows:4,placeholder:"**gras**, [c=#dc2626]couleur[/c], retours à la ligne..."})}),e.jsx(d,{item:!0,xs:6,children:e.jsx(y,{label:"FARM / (70u, 120u...)",fullWidth:!0,value:s.tag,onChange:r=>u({...s,tag:r.target.value}),placeholder:"ex: FARM / 120u"})}),e.jsx(d,{item:!0,xs:12,children:e.jsxs(f,{sx:{p:2,border:"1px solid",borderColor:"divider",borderRadius:2,bgcolor:"background.default"},children:[e.jsx(b,{variant:"subtitle2",color:"text.secondary",sx:{mb:2,display:"block"},children:"Catégorie du produit"}),e.jsxs(j,{direction:{xs:"column",sm:"row"},spacing:2,alignItems:"stretch",children:[e.jsxs(y,{select:!0,label:"Catégorie",fullWidth:!0,size:"small",value:v?.id??"",onChange:r=>{const o=r.target.value;u({...s,categoryId:o})},sx:{minWidth:{sm:200}},children:[e.jsx(T,{value:"",children:"Aucune"}),F.map(r=>e.jsx(T,{value:r.id,children:r.name},r.id))]}),k.length>0&&e.jsxs(y,{select:!0,label:"Sous-catégorie",fullWidth:!0,size:"small",value:H||v?.id||"",onChange:r=>u({...s,categoryId:r.target.value}),sx:{minWidth:{sm:200}},children:[e.jsx(T,{value:v?.id??"",children:v?.name??"— Catégorie principale"}),k.map(r=>e.jsx(T,{value:r.id,children:r.name},r.id))]})]})]})}),e.jsx(d,{item:!0,xs:12,children:e.jsxs(ce,{defaultExpanded:!0,sx:{border:"1px solid",borderColor:"divider",boxShadow:"none"},children:[e.jsx(de,{expandIcon:e.jsx(x,{icon:"material-symbols:expand-more"}),children:e.jsxs(b,{variant:"subtitle1",sx:{fontWeight:600},children:["Tarifs et Variantes (",h.length,")"]})}),e.jsxs(ue,{children:[e.jsx(M,{variant:"contained",size:"small",onClick:ee,startIcon:e.jsx(x,{icon:"material-symbols:add"}),sx:{mb:2},children:"Ajouter un tarif"}),h.map((r,o)=>e.jsx(f,{sx:{p:1.5,mb:1.5,border:"1px solid",borderColor:"divider",borderRadius:1,bgcolor:"background.paper"},children:e.jsxs(d,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(d,{item:!0,xs:5,sm:5,children:e.jsx(y,{label:"Grammage",size:"small",fullWidth:!0,value:r.name,type:"text",inputProps:{inputMode:"decimal"},onChange:i=>{let t=i.target.value.replace(/,/g,".").replace(/[^0-9.]/g,"");if((t.match(/\./g)||[]).length>1){const g=t.indexOf(".");t=t.slice(0,g+1)+t.slice(g+1).replace(/\./g,"")}$(o,"name",t)},placeholder:"ex: 5, 5.5, 10 ou 2.5"})}),e.jsx(d,{item:!0,xs:5,sm:5,children:e.jsx(y,{label:"Prix €",size:"small",fullWidth:!0,value:r.price,type:"number",inputProps:{inputMode:"decimal",step:"0.01"},onChange:i=>{const t=i.target.value.replace(/,/g,".").replace(/[^0-9.]/g,"");$(o,"price",t)},placeholder:"ex: 10.00"})}),e.jsx(d,{item:!0,xs:2,sm:2,sx:{textAlign:"center"},children:e.jsx(z,{onClick:()=>re(o),color:"error",size:"small",children:e.jsx(x,{icon:"material-symbols:delete",fontSize:"small"})})})]})},o))]})]})}),e.jsx(d,{item:!0,xs:12,children:e.jsxs(j,{direction:"row",spacing:2,justifyContent:"flex-end",children:[e.jsx(M,{variant:"outlined",onClick:()=>w("/product"),sx:{minWidth:120},children:"Annuler"}),e.jsx(M,{variant:"contained",onClick:Z,disabled:O||U,sx:{bgcolor:"primary.main",color:"common.black",minWidth:120,"&:hover":{bgcolor:"primary.dark"}},children:O?"Sauvegarde...":U?"Upload vidéo...":"Enregistrer"})]})})]})})]})};export{Re as default};
