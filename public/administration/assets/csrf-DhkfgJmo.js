function u(){const s=document.cookie.split(";");for(const e of s){const[n,o]=e.trim().split("=");if(n==="csrf-token")return o||""}return""}async function l(){let s=u();if(s)return s;try{await fetch("/api/csrf-token",{credentials:"include"}),await new Promise(e=>setTimeout(e,100)),s=u()}catch(e){console.error("Failed to get CSRF token:",e)}return s}function p(s,e,n={}){return new Promise(async(o,c)=>{const a=await l(),t=new XMLHttpRequest;t.open("POST",s),t.withCredentials=!0,t.setRequestHeader("Content-Type",e.type||"application/octet-stream"),t.setRequestHeader("x-file-name",encodeURIComponent(e.name)),a&&t.setRequestHeader("x-csrf-token",a),t.upload.onprogress=r=>{r.lengthComputable&&n.onProgress&&n.onProgress(Math.round(r.loaded/r.total*100))},t.onload=()=>{const r=new Headers,f=t.getAllResponseHeaders();f&&f.split(`\r
`).forEach(i=>{const d=i.indexOf(": ");d>0&&r.set(i.slice(0,d).trim(),i.slice(d+2).trim())}),o(new Response(t.responseText,{status:t.status,statusText:t.statusText,headers:r}))},t.onerror=()=>c(new Error("Upload failed")),t.send(e)})}async function h(s,e={}){const n=e.method?.toUpperCase()||"GET",o=["POST","PUT","DELETE","PATCH"].includes(n),c=o?await l():u(),a=new Headers(e.headers);return c&&o&&a.set("x-csrf-token",c),fetch(s,{...e,headers:a,credentials:e.credentials??"include"})}export{h as f,p as u};
