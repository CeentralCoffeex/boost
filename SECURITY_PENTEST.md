# Tests de sécurité (pentest) — commandes et checklist

## 1. Dépendances

```powershell
cd d:\Users\yo\Desktop\plugs
npm audit
npm audit --audit-level=high
```

**Résultat actuel :** 0 vulnérabilités (npm audit).

---

## 2. Lancer le serveur pour tester en local

```powershell
cd d:\Users\yo\Desktop\plugs
npm run dev
```

Puis dans un autre terminal, exécuter les requêtes ci‑dessous (remplace `localhost:3000` par ton URL si besoin).

---

## 3. Tests API (sans auth — doivent être refusés)

À lancer avec **PowerShell** ou **curl** une fois le serveur démarré.

### Catalogue / produits sans initData Telegram (attendu : 403)

```powershell
Invoke-WebRequest -Uri "http://localhost:3000/api/products" -Method GET -UseBasicParsing | Select-Object StatusCode, Content
```

```powershell
Invoke-WebRequest -Uri "http://localhost:3000/api/categories" -Method GET -UseBasicParsing | Select-Object StatusCode, Content
```

```powershell
Invoke-WebRequest -Uri "http://localhost:3000/api/settings" -Method GET -UseBasicParsing | Select-Object StatusCode, Content
```

**Résultat attendu :** StatusCode 403 et corps du type `BOT_DETECTED` ou erreur d’auth.

### Uploads sans token signé (attendu : 403)

```powershell
Invoke-WebRequest -Uri "http://localhost:3000/api/uploads/quelque-fichier.webp" -Method GET -UseBasicParsing | Select-Object StatusCode
```

**Résultat attendu :** 403 Forbidden.

### Path traversal sur uploads (attendu : 400)

```powershell
Invoke-WebRequest -Uri "http://localhost:3000/api/uploads/..%2F..%2Fpackage.json?token=xx&expires=1" -Method GET -UseBasicParsing | Select-Object StatusCode
```

**Résultat attendu :** 400 ou 403, jamais le contenu d’un fichier hors uploads.

### Admin verify sans session ni initData (attendu : 401)

```powershell
Invoke-WebRequest -Uri "http://localhost:3000/api/admin/verify" -Method GET -UseBasicParsing | Select-Object StatusCode, Content
```

**Résultat attendu :** 401.

---

## 4. Vérifications dans le code (déjà fait)

| Élément | Statut |
|--------|--------|
| **npm audit** | 0 vulnérabilités |
| **dangerouslySetInnerHTML** | Utilisé uniquement pour du CSS/script statique en dur dans `layout.tsx` (pas d’entrée utilisateur). |
| **formatted-text** | Décodage via `textarea.innerHTML` puis strip des balises ; affichage en nœuds texte React. À garder en tête pour tout contenu utilisateur. |
| **executeRawQuery** | **Supprimé** de `src/lib/prisma.ts` (risque d’injection SQL — ce qui n’existe pas ne peut pas être exploité). |
| **Erreurs 500 en prod** | Gestionnaire `src/lib/api-error.ts` : en production, le client reçoit un message générique ; les détails (Prisma, stack) sont logués côté serveur uniquement. |
| **Uploads / path traversal** | Contrôle `..` dans le nom de fichier → 400. |
| **Secrets** | Utilisation de `process.env` (TELEGRAM_BOT_TOKEN, NEXTAUTH_SECRET, etc.) — pas de secret en dur dans le code. |

---

## 5. Commandes utiles (résumé)

```powershell
# Audit des deps
npm audit
npm audit --audit-level=critical

# Lancer le serveur
npm run dev

# (Optionnel) Build prod puis lancer
npm run build
npm start
```

Tester les URLs ci‑dessus avec `Invoke-WebRequest` ou curl une fois le serveur démarré.

---

## 6. En production

- Utiliser **HTTPS**.
- Vérifier **TELEGRAM_WEBHOOK_SECRET** et **NEXTAUTH_SECRET** forts et uniques.
- Ne pas exposer `.env` ni fichiers sensibles.
- Activer **Bot Fight Mode** et règles WAF sur Cloudflare si utilisé (voir `SECURITY.md`).
